<div class="container-fluid">
  <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
    <div class="card-header bg-gradient-primary d-flex justify-content-between align-items-center py-3">
      <h4 class="mb-0 fw-bold text-white">
        <i class="bi bi-gear-wide-connected me-2"></i>Webinar Management & Operations
      </h4>
    </div>
    
    <div class="card-body p-0">
      <!-- Filters Section -->
      <div class="d-flex flex-wrap justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2 mb-md-0">
          <!-- <div class="me-2" style="min-width: 200px;">
            <label for="statusSelect" class="form-label mb-1">Status</label>
            <select
              id="statusSelect"
              class="form-control"
              [(ngModel)]="filters.status"
              (change)="onFilterChange()">
              <option value="">--All Status--</option>
              <option value="scheduled">Scheduled</option>
              <option value="live">Live</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          
          <div class="me-2" style="min-width: 200px;">
            <label for="accessTypeSelect" class="form-label mb-1">Access Type</label>
            <select
              id="accessTypeSelect"
              class="form-control"
              [(ngModel)]="filters.accessType"
              (change)="onFilterChange()">
              <option value="">--All Types--</option>
              <option value="free">Free</option>
              <option value="paid">Paid</option>
            </select>
          </div> -->
          
          <div class="me-2">
            <label for="searchInput" class="form-label mb-1">Search</label>
            <input
              id="searchInput"
              type="text"
              class="form-control"
              [(ngModel)]="filters.search"
              (input)="onFilterChange()"
              placeholder="Search webinars">
          </div>
          
          <div class="mt-4">
            <button class="btn btn-outline-secondary" (click)="resetFilters()">
              <i class="bi bi-x-circle me-1"></i>Reset
            </button>
          </div>
        </div>
        
        <div class="d-flex align-items-center">
          <div class="ms-2">
            <select
              id="limitSelect"
              class="form-control"
              [(ngModel)]="filters.limit"
              (change)="onFilterChange()">
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="text-center my-5 py-5">
      <div class="spinner-grow text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Webinars Table -->
    <div class="table-responsive" *ngIf="!loading && webinars.docs && webinars.docs.length > 0">
      <table class="table table-hover align-middle mb-0">
        <thead class="bg-light">
          <tr>
            <th class="py-3">Sr No</th>
            <th class="py-3">Title</th>
            <th class="py-3">Date</th>
            <th class="py-3">Time</th>
            <th class="py-3">Status</th>
            <!-- <th class="py-3">Recording</th> -->
            <th class="py-3">Registrations</th>
            <!-- <th class="py-3">Live Attendees</th> -->
            <th class="py-3">Operations</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let webinar of webinars.docs | paginate: { id: paginationConfig.id, itemsPerPage: webinars.limit, currentPage: webinars.page, totalItems: webinars.totalDocs }; let i = index">
            <tr *ngIf="webinar && webinar._id && webinar.title" class="border-bottom">
              <td class="py-3">{{ (webinars.page - 1) * webinars.limit + i + 1 }}</td>
              <td class="py-3">
                <div>
                  <strong>{{ webinar.title }}</strong>
                  <br>
                  <small class="text-muted">{{ webinar.topic || 'No topic' }}</small>
                </div>
              </td>
              <td class="py-3">{{ formatDate(webinar.date) }}</td>
              <td class="py-3">{{ webinar.startTime }} - {{ webinar.endTime }}</td>
              <td class="py-3">
                <span class="badge" [ngClass]="getStatusBadgeClass(webinar.status)">
                  {{ webinar.status | titlecase }}
                </span>
              </td>
              <!-- <td class="py-3">
                <span class="badge" [ngClass]="getRecordingStatusBadgeClass(webinar.recordingStatus)">
                  {{ webinar.recordingStatus | titlecase }}
                </span>
                <div *ngIf="hasRecordingRequests(webinar)" class="mt-1">
                  <small class="text-warning">
                    <i class="bi bi-clock-history"></i>
                    {{ webinar.recordingRequests.length }} requests
                  </small>
                </div>
              </td> -->
              <td class="py-3">
                <span class="badge bg-info">
                  {{ webinar.registeredUsers?.length || 0 }}
                </span>
              </td>
              <!-- <td class="py-3">
                <span class="badge bg-success">
                  {{ webinar.currentLiveCount || 0 }}
                </span>
              </td> -->
              <td class="py-3">
                <div class="btn-group" role="group">
                  <!-- Start Streaming Button -->
                  <button 
                    *ngIf="canStartStreaming(webinar)"
                    class="btn btn-sm btn-success me-1"
                    (click)="openStreamingModal(webinar)"
                    [disabled]="loading">
                    <i class="bi bi-play-circle"></i>
                    Start Live
                  </button>

                  <!-- End Webinar Button -->
                  <button 
                    *ngIf="canEndWebinar(webinar)"
                    class="btn btn-sm btn-danger me-1"
                    (click)="endWebinar(webinar)"
                    [disabled]="loading">
                    <i class="bi bi-stop-circle"></i>
                    End
                  </button>

                  <!-- Upload Recording Button -->
                  <button 
                    *ngIf="canUploadRecording(webinar)"
                    class="btn btn-sm btn-primary me-1"
                    (click)="openRecordingModal(webinar)"
                    [disabled]="loading">
                    <i class="bi bi-cloud-upload"></i>
                    Upload
                  </button>

                  <!-- Recording Requests Button -->
                  <button 
                    *ngIf="hasRecordingRequests(webinar)"
                    class="btn btn-sm btn-warning me-1"
                    (click)="openRecordingRequestsModal(webinar)"
                    [disabled]="loading">
                    <i class="bi bi-person-check"></i>
                    Requests
                  </button>

                  <!-- Status indicators for completed actions -->
                  <span *ngIf="webinar.status === 'completed' && webinar.isRecorded" class="text-success">
                    <i class="bi bi-check-circle" title="Recording uploaded"></i>
                  </span>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="d-flex justify-content-between align-items-center p-3 border-top">
        <div *ngIf="webinars.docs && webinars.docs.length > 0" class="text-muted">
          Showing {{ (webinars.page - 1) * webinars.limit + 1 }} to
          {{ Math.min(webinars.page * webinars.limit, webinars.totalDocs) }}
          of {{ webinars.totalDocs }} entries
        </div>
        <pagination-controls
          [id]="paginationConfig.id"
          [maxSize]="5"
          [responsive]="true"
          (pageChange)="onPageChange($event)"
          previousLabel="Previous"
          nextLabel="Next"
          [directionLinks]="true">
        </pagination-controls>
      </div>
    </div>

    <!-- No Webinars Found -->
    <div *ngIf="!loading && (!webinars.docs || webinars.docs.length === 0)" class="text-center my-5 py-4 px-4">
      <div class="empty-state">
        <i class="bi bi-camera-video fs-1 text-muted mb-3"></i>
        <h5>No Webinars Found</h5>
        <p class="text-muted">No webinars match your current filter criteria.</p>
        <button class="btn btn-outline-primary rounded-pill mt-3" (click)="resetFilters()">
          <i class="bi bi-arrow-repeat me-2"></i>Reset Filters
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Start Streaming Modal -->
<div *ngIf="showStreamingModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-play-circle me-2"></i>Start Live Streaming
        </h5>
        <button type="button" class="btn-close" (click)="closeStreamingModal()" [disabled]="modalLoading"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Starting live streaming for: <strong>{{ selectedWebinar?.title }}</strong>
        </div>
        <form [formGroup]="streamingForm">
          <div class="mb-3">
            <label class="form-label">Streaming URL <span class="text-danger">*</span></label>
            <input 
              type="url" 
              class="form-control" 
              formControlName="streamingUrl"
              placeholder="https://your-streaming-server.com/stream-url"
              [class.is-invalid]="streamingForm.get('streamingUrl')?.touched && streamingForm.get('streamingUrl')?.invalid">
            <div *ngIf="streamingForm.get('streamingUrl')?.touched && streamingForm.get('streamingUrl')?.invalid" class="invalid-feedback">
              Please enter a valid streaming URL
            </div>
            <div class="form-text">
              Enter the live streaming URL from your streaming service (e.g., WebRTC or HLS endpoint)
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeStreamingModal()" [disabled]="modalLoading">
          Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="startStreaming()" [disabled]="modalLoading || streamingForm.invalid">
          <span *ngIf="modalLoading" class="spinner-border spinner-border-sm me-2"></span>
          <i class="bi bi-play-circle me-1"></i>
          Start Streaming
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Upload Recording Modal -->
<div *ngIf="showRecordingModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-cloud-upload me-2"></i>Upload Recording
        </h5>
        <button type="button" class="btn-close" (click)="closeRecordingModal()" [disabled]="modalLoading"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Uploading recording for: <strong>{{ selectedWebinar?.title }}</strong>
        </div>
        <form [formGroup]="recordingForm">
          <div class="mb-3">
            <label class="form-label">Recording URL <span class="text-danger">*</span></label>
            <input 
              type="url" 
              class="form-control" 
              formControlName="recordingUrl"
              placeholder="https://your-storage.com/recordings/webinar-recording.mp4"
              [class.is-invalid]="recordingForm.get('recordingUrl')?.touched && recordingForm.get('recordingUrl')?.invalid">
            <div *ngIf="recordingForm.get('recordingUrl')?.touched && recordingForm.get('recordingUrl')?.invalid" class="invalid-feedback">
              Please enter a valid recording URL
            </div>
            <div class="form-text">
              Enter the URL where the webinar recording is hosted
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeRecordingModal()" [disabled]="modalLoading">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="uploadRecording()" [disabled]="modalLoading || recordingForm.invalid">
          <span *ngIf="modalLoading" class="spinner-border spinner-border-sm me-2"></span>
          <i class="bi bi-cloud-upload me-1"></i>
          Upload Recording
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Recording Requests Modal -->
<div *ngIf="showRecordingRequestsModal" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-person-check me-2"></i>Recording Requests
        </h5>
        <button type="button" class="btn-close" (click)="closeRecordingRequestsModal()" [disabled]="modalLoading"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Managing recording requests for: <strong>{{ selectedWebinar?.title }}</strong>
        </div>

        <div *ngIf="recordingRequests.length === 0" class="text-center py-4">
          <i class="bi bi-inbox fs-1 text-muted mb-3"></i>
          <h6>No Recording Requests</h6>
          <p class="text-muted">There are no recording requests for this webinar.</p>
        </div>

        <div *ngIf="recordingRequests.length > 0" class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Requested At</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of recordingRequests">
                <td>
                  <div>
                    <strong>{{ request.userId?.name || 'Unknown User' }}</strong>
                    <br>
                    <small class="text-muted">{{ request.userId?.email || 'No email' }}</small>
                  </div>
                </td>
                <td>{{ formatDate(request.requestedAt) }}</td>
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-warning': request.status === 'pending',
                    'bg-success': request.status === 'approved',
                    'bg-danger': request.status === 'rejected'
                  }">
                    {{ request.status | titlecase }}
                  </span>
                </td>
                <td>
                  <div *ngIf="request.status === 'pending'" class="btn-group" role="group">
                    <button 
                      class="btn btn-sm btn-success me-1"
                      (click)="approveRecordingRequest(request._id, 'approved')"
                      [disabled]="modalLoading">
                      <i class="bi bi-check-circle me-1"></i>Approve
                    </button>
                    <button 
                      class="btn btn-sm btn-danger"
                      (click)="approveRecordingRequest(request._id, 'rejected', 'Request declined by admin')"
                      [disabled]="modalLoading">
                      <i class="bi bi-x-circle me-1"></i>Reject
                    </button>
                  </div>
                  <div *ngIf="request.status !== 'pending'" class="text-muted">
                    <small>
                      {{ request.status === 'approved' ? 'Approved' : 'Rejected' }} 
                      {{ request.approvedAt ? 'on ' + formatDate(request.approvedAt) : '' }}
                    </small>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeRecordingRequestsModal()" [disabled]="modalLoading">
          Close
        </button>
      </div>
    </div>
  </div>
</div>